<script>
  const usernameInput = document.getElementById('username');
  const passwordInput = document.getElementById('password');
  const showPassword = document.getElementById('showPassword');
  const actionBtn = document.getElementById('action-btn');
  const toggleBtn = document.getElementById('toggle-btn');
  const errorEl = document.getElementById('error');
  const logoutBtn = document.getElementById('logout-btn');
  const mainContent = document.getElementById('main-content');
  const authTitle = document.getElementById('auth-title');

  let isLogin = true;
  let loggedInUser = null;

  // modal elements
  const modal = document.createElement('div');
  modal.className = 'modal';
  modal.innerHTML = `
    <div class="modal-content">
      <span class="close">&times;</span>
      <h3>Change Password</h3>
      <input type="password" id="currentPasswordInput" placeholder="Current Password">
      <input type="password" id="newPasswordInput" placeholder="New Password">
      <button id="changeBtn">Change Password</button>
      <p id="changeMsg"></p>
    </div>`;
  document.body.appendChild(modal);

  const closeModal = modal.querySelector('.close');
  const changeBtn = modal.querySelector('#changeBtn');
  const currentPasswordInput = modal.querySelector('#currentPasswordInput');
  const newPasswordInput = modal.querySelector('#newPasswordInput');
  const changeMsg = modal.querySelector('#changeMsg');

  // Hashing function
  async function hashPassword(password) {
    const enc = new TextEncoder();
    const hashBuffer = await crypto.subtle.digest('SHA-256', enc.encode(password));
    return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
  }

  // Preload test account: test / 1234
  (async () => {
    const testUser = 'test';
    const testPass = '1234';
    if (!localStorage.getItem('user_' + testUser)) {
      const hashed = await hashPassword(testPass);
      localStorage.setItem('user_' + testUser, hashed);
    }
  })();

  function showCards(show) {
    document.querySelectorAll('.card').forEach(c => c.style.display = show ? 'flex' : 'none');
    logoutBtn.style.display = show ? 'block' : 'none';
  }

  actionBtn.addEventListener('click', async () => {
    const username = usernameInput.value.trim();
    const password = passwordInput.value.trim();
    if(!username || !password){ errorEl.textContent = 'Enter both fields!'; return; }

    const storedHash = localStorage.getItem('user_' + username);
    const hash = await hashPassword(password);

    if(isLogin){
      if(storedHash === hash){
        loggedInUser = username;
        errorEl.textContent = '';
        showCards(true);
        document.getElementById('auth-box').style.display = 'none';
      } else {
        errorEl.textContent = 'Invalid username or password!';
      }
    } else {
      if(storedHash){
        errorEl.textContent = 'Username already exists!';
      } else {
        localStorage.setItem('user_' + username, hash);
        errorEl.style.color = '#a3f7b5';
        errorEl.textContent = 'Account created! You can now login.';
        usernameInput.value = '';
        passwordInput.value = '';
        toggleBtn.click(); // switch to login
      }
    }
  });

  toggleBtn.addEventListener('click', () => {
    isLogin = !isLogin;
    actionBtn.textContent = isLogin ? 'Login' : 'Sign Up';
    authTitle.textContent = isLogin ? 'Login' : 'Sign Up';
    errorEl.textContent = '';
  });

  showPassword.addEventListener('change', () => {
    passwordInput.type = showPassword.checked ? 'text' : 'password';
  });

  logoutBtn.addEventListener('click', () => {
    loggedInUser = null;
    showCards(false);
    document.getElementById('auth-box').style.display = 'flex';
  });

  // Change password modal
  logoutBtn.insertAdjacentElement('afterend', (() => {
    const btn = document.createElement('button');
    btn.textContent = 'Change Password';
    btn.className = 'btn';
    btn.style.marginBottom = '1rem';
    btn.addEventListener('click', () => { modal.style.display = 'block'; });
    return btn;
  })());

  closeModal.addEventListener('click', () => { modal.style.display = 'none'; });
  window.addEventListener('click', (e) => { if(e.target === modal) modal.style.display = 'none'; });

  changeBtn.addEventListener('click', async () => {
    if(!loggedInUser){ changeMsg.textContent = 'You must be logged in!'; return; }
    const current = currentPasswordInput.value.trim();
    const next = newPasswordInput.value.trim();
    if(!current || !next){ changeMsg.textContent = 'Enter both fields!'; return; }

    const storedHash = localStorage.getItem('user_' + loggedInUser);
    const currentHash = await hashPassword(current);

    if(currentHash === storedHash){
      const newHash = await hashPassword(next);
      localStorage.setItem('user_' + loggedInUser, newHash);
      changeMsg.style.color = '#a3f7b5';
      changeMsg.textContent = 'Password changed successfully!';
      currentPasswordInput.value = '';
      newPasswordInput.value = '';
      modal.style.display = 'none';
    } else {
      changeMsg.style.color = '#ffcccb';
      changeMsg.textContent = 'Current password is incorrect!';
    }
  });
</script>
